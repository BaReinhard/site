---
layout: default
include_footer: false
classname: map

title: Map, Food Oasis Los Angeles

stylesheets:
  - "https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.css"
---
{% if false %}
<form class="find" action="/map" method="get">
	<p>
		<label>
			<span>Enter your location</span><br />
			<input type="text" name="address" placeholder="Address, Neighborhood, or Zip" autocomplete="off" autocorrect="off" />
		</label>
		<button type="submit">
			<!--
			Search icon
			by Veronika Krpciarova
			https://thenounproject.com/v.krpciarova/collection/search/?oq=search&cidx=1&i=353178
			-->
			<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="20" height="20">
				<switch>
					<path fill="#FFFFFF" d=" M 83.7 77.7 Q 83.6751953125 77.5302734375 83.55 77.4 L 62.65 54.95 Q 67.4498046875 48.480859375 67.45 40 67.44765625 29.3423828125 59.85 21.75 52.3580078125 14.252734375 41.7 14.25 31.0427734375 14.2533203125 23.45 21.75 15.9533203125 29.3427734375 15.95 40 15.952734375 50.6580078125 23.45 58.15 31.0423828125 65.74765625 41.7 65.75 48.7376953125 65.747265625 54.45 62.45 L 76.15 85.5 Q 76.26796875 85.6412109375 76.4 85.7 76.5693359375 85.7599609375 76.7 85.75 81.1939453125 85.53125 82.9 83.5 84.7708984375 81.51328125 83.7 77.7 M 51.75 29.9 Q 55.9521484375 34.107421875 55.95 40 55.9521484375 45.8923828125 51.75 50.05 47.5923828125 54.2521484375 41.7 54.25 35.807421875 54.2521484375 31.6 50.05 27.44765625 45.8923828125 27.45 40 27.44765625 34.107421875 31.6 29.9 35.807421875 25.74765625 41.7 25.75 47.5923828125 25.74765625 51.75 29.9 Z"></path>
					<foreignobject>Go</foreignobject>
				</switch>
			</svg>
		</button>
	</p>
</form>
{% endif %}

<nav class="search">
	<h1>Map of food near you</h1>
	<ul>
		<li class="map"><a>Map</a></li>
		<li class="list"><a href="/list">List</a></li>
	</ul>
</nav>

<!--
<nav class="map-filters"></nav>
-->

<div id="map" class="mapbox"></div>

<div id="map-not-supported-message" class="message" style="display: none; position: absolute; bottom: 0; left: 0; width: 100%; z-index: 1; padding: 1.5em; text-align: center; background: white; z-index: 9999; box-sizing: border-box;">
	<h1 style="margin-top: 0;">Uh oh!</h1>
	<p style="max-width: none;">Our map isn’t working in this web browser. You may want to try viewing the <a href="/list">list of locations</a> instead.</p>
	<p style="max-width: none;" class="action"><a href="/list">Show me the list</a></p>
</div>

<!-- For map.js -->
<script type="text/template" id="you-are-here-template">
	<div class="you-are-here"><span>You are here</span></div>
</script>

<script type="text/template" id="marker-template">
	<div class="marker">
		<img src="/assets/images/markers/purple.svg" alt="" />
	</div>
</script>

<script type="text/template" id="popup-template">
	<div class="map-point-details">
		<h3><a href=""></a></h3>
		<p class="type"></p>
		<p class="address"></p>
		<p class="phone"></p>
		<h4>Hours</h4>
		<p class="hours"></p>
		<p class="distance"><span></span> miles away</p>
	</div>
</script>

<!-- Jim’s Google Maps API key -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBP5KxqO9v1sLhXlkrG3vDiDdOJvYLJ0H4"></script>

<script src='https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.js'></script>
<script>

	var MAP_ACCESS_TOKEN = 'pk.eyJ1IjoiZm9vZG9hc2lzbGEiLCJhIjoiY2l0ZjdudnN4MDhpYzJvbXlpb3IyOHg2OSJ9.POBdqXF5EIsGwfEzCm8Y3Q';

	var MAP_START_POSITION = [34.052235, -118.243683];

	var MAP_BOUNDS = [
		[-119.9442369,32.7089729], // Southwest coordinates
		[-116.63282912,35.8275538]  // Northeast coordinates
	];

	/*
	Colors…

	@asparagus:   rgb(161, 167, 72)
	@banana:      rgb(249, 192, 88)
	@strawberry:  rgb(241, 95, 91)
	@lime:        rgb(144, 194, 70)
	@blueberry:   rgb(77, 85, 148)
	@dragonfruit: rgb(211, 16, 134)
	*/
	var MAP_LAYERS = [
		{
			name: 'food-pantry',
			label: 'Food Pantry',
			sourceLayer: 'Food-Pantries_09-24-50izc5',
			sourceURL: 'mapbox://foodoasisla.47r06atm',
			color: 'rgba(229, 172, 68, 1)' /* @banana */
		},
		{
			name: 'community-garden',
			label: 'Community Garden',
			sourceLayer: 'CommunityGardens_MASTER-9v3gaq',
			sourceURL: 'mapbox://foodoasisla.2y4svag1',
			color: 'rgba(124, 174, 50, 1)' /* @lime */
		},
		{
			name: 'farmers-market',
			label: 'Farmers Market',
			sourceLayer: 'Farmers-Markets_08-17-3rvtq4',
			sourceURL: 'mapbox://foodoasisla.7cdn2m99',
			color: 'rgba(241, 95, 91, 1)' /* @strawberry */
		}
	];

</script>

<style>
/*
 * Unlike other icons, you can style `L.divIcon` with CSS.
 * These styles make each marker a pink triangle.
 */
.css-icon {
  width: 0;
  height: 0;
  border-top: 30px solid transparent;
  border-bottom: 30px solid transparent;
  border-left: 30px solid #ff8888;
  }

.farmers-market-marker {
	border: none;
	cursor: pointer;
	height: 56px;
	width: 43px;
	background-image: url(/assets/images/map/farmers-market.svg);
	background-color: rgba(0, 0, 0, 0);
	transform: translate(28px, 56px, 0);
}

.community-garden-marker {
	border: none;
	cursor: pointer;
	height: 56px;
	width: 43px;
	background-image: url(/assets/images/map/community-garden.svg);
	background-color: rgba(0, 0, 0, 0);
	transform: translate(28px, 56px, 0);
}

.food-pantry-marker {
	border: none;
	cursor: pointer;
	height: 56px;
	width: 43px;
	background-image: url(/assets/images/map/food-bank.svg);
	background-color: rgba(0, 0, 0, 0);
	transform: translate(28px, 56px, 0);
}

</style>

<script>

var INFINITY = 9999999;
function getDistanceForPresentation(kilometers) {	
	if (kilometers === INFINITY) return 'unknown';

	var miles = kilometers / 1.609; // kilometers per mile
	miles = Math.round10(miles, -1); // Round to one decimal place
	return parseFloat(miles.toFixed(1));
}

function createPopupElement(data) {

	var template = document.getElementById('popup-template');
	if (template) {
		var element = document.createElement('div');
		element.innerHTML = template.innerHTML;
		element.querySelector('.map-point-details').className +=
			' ' + data.category.toLowerCase().replace(' ', '-') + '-details'; // Example: farmers-market-details

		// Name
		var nameElement = element.querySelector('h3');
		var link = nameElement.querySelector('a');
		link.setAttribute('href', data.uri);
		link.innerText = data.name;

		// Category (Type)
		var typeElement = element.querySelector('.type');
		typeElement.innerText = data.category;

		// Address
		if (data.address_1) element.querySelector('.address').innerHTML = data.address_1;

		// Hours
		var hoursElement = element.querySelector('.hours');
		if (data.hours) {
			hoursElement.innerHTML = data.hours;
		} else {
			var h4 = element.querySelector('h4');
			h4.parentNode.removeChild(h4);

			hoursElement.parentNode.removeChild(hoursElement);
		}

		// Address
		if (data.distance) element.querySelector('.distance span').innerHTML = getDistanceForPresentation(data.distance);

		return element;
	}
}

var locations = [
	{
		latitude: 34.054,
		longitude: -118.2432,
		name: 'Arts District Little Tokyo Farmers Market',
		address_1: '200 N Spring St',
		category: 'Farmers Market',
		uri: '/farmers-market/arts-district-little-tokyo/'
	},
	{
		latitude: 34.05707,
		longitude: -118.239577,
		name: 'Our Lady Queen of Angels Catholic Church',
		address_1: '535 N. Main Street',
		category: 'Food Pantry',
		uri: '/food-pantry/our-lady-queen-of-angels-catholic-church/'
	},
];

var locations = [

{% assign data_collection = site.collections | where: "label", "community-gardens" | first %}
{% assign data_list = data_collection.docs %}
{% for data in data_list %}
{
	latitude  : "{{ data.latitude }}",
	longitude : "{{ data.longitude }}",
	name      : "{{ data.name }}",
	address_1 : "{{ data.address_1 | replace: '"', '' }}",
	category  : "{{ data.category }}",
	hours     : "{{ data.hours }}",
	uri       : "{{ data.url }}"
},
{% endfor %}

{% assign data_collection = site.collections | where: "label", "farmers-markets" | first %}
{% assign data_list = data_collection.docs %}
{% for data in data_list %}
{
	latitude  : "{{ data.latitude }}",
	longitude : "{{ data.longitude }}",
	name      : "{{ data.name }}",
	address_1 : "{{ data.address_1 | replace: '"', '' }}",
	category  : "{{ data.category }}",
	hours     : "{{ data.hours }}",
	uri       : "{{ data.url }}"
},
{% endfor %}

{% assign data_collection = site.collections | where: "label", "food-pantries" | first %}
{% assign data_list = data_collection.docs %}
{% for data in data_list %}
{
	latitude  : "{{ data.latitude }}",
	longitude : "{{ data.longitude }}",
	name      : "{{ data.name }}",
	address_1 : "{{ data.address_1 | replace: '"', '' }}",
	category  : "{{ data.category }}",
	hours     : "{{ data.hours }}",
	uri       : "{{ data.url }}"
}{% unless forloop.last %},{% endunless %}
{% endfor %}

];


(function() {

	var LOS_ANGELES = {
		latitude: 34.052234,
		longitude: -118.243685
	};

	function findUserLocation() {
		var address = getParameterByName('address');

		// If the user passed in an address, and if the Google Maps geocoder is available
		if (address && "google" in window) {

			// Add Los Angeles to the address
			if (address.indexOf('Los Angeles') < 0) {
				address += ' Los Angeles';
			}

			var geocoder = new google.maps.Geocoder();

			geocoder.geocode({'address': address}, function(results, status) {
				if (status === google.maps.GeocoderStatus.OK) {

					var latitude  = results[0].geometry.location.lat();
					var longitude = results[0].geometry.location.lng();

					//console.log('latitude: ' + latitude);
					//console.log('longitude: ' + longitude);

					sortByClosest(latitude, longitude, false);

				} else {
					console.error('Geocode was not successful for the following reason: ' + status);
					sortByClosest(LOS_ANGELES.latitude, LOS_ANGELES.longitude, false);
				}
			});

		// Else if automatic geolocation is available
		} else if ("geolocation" in navigator) {

			navigator.geolocation.getCurrentPosition(function(position) {

				sortByClosest(position.coords.latitude, position.coords.longitude, true);
				//if (document.getElementById('location')) document.getElementById('location').innerHTML = 'near you';

			}, function() {
				console.error("Unable to retrieve your location");
				sortByClosest(LOS_ANGELES.latitude, LOS_ANGELES.longitude, false);
			});
		} else {
			sortByClosest(LOS_ANGELES.latitude, LOS_ANGELES.longitude, false);
		}
	}

	// http://stackoverflow.com/questions/11832914/round-to-at-most-2-decimal-places-in-javascript#12830454#answer-25075575
	// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/round#Decimal_rounding
	(function() {
		/**
		 * Decimal adjustment of a number.
		 *
		 * @param {String}  type  The type of adjustment.
		 * @param {Number}  value The number.
		 * @param {Integer} exp   The exponent (the 10 logarithm of the adjustment base).
		 * @returns {Number} The adjusted value.
		 */
		function decimalAdjust(type, value, exp) {
			// If the exp is undefined or zero...
			if (typeof exp === 'undefined' || +exp === 0) {
				return Math[type](value);
			}
			value = +value;
			exp = +exp;
			// If the value is not a number or the exp is not an integer...
			if (isNaN(value) || !(typeof exp === 'number' && exp % 1 === 0)) {
				return NaN;
			}
			// Shift
			value = value.toString().split('e');
			value = Math[type](+(value[0] + 'e' + (value[1] ? (+value[1] - exp) : -exp)));
			// Shift back
			value = value.toString().split('e');
			return +(value[0] + 'e' + (value[1] ? (+value[1] + exp) : exp));
		}

		// Decimal round
		if (!Math.round10) {
			Math.round10 = function(value, exp) {
				return decimalAdjust('round', value, exp);
			};
		}
		// Decimal floor
		if (!Math.floor10) {
			Math.floor10 = function(value, exp) {
				return decimalAdjust('floor', value, exp);
			};
		}
		// Decimal ceil
		if (!Math.ceil10) {
			Math.ceil10 = function(value, exp) {
				return decimalAdjust('ceil', value, exp);
			};
		}
	})();

	function sortByClosest(latitude, longitude, geolocated) {
		// console.log("inside sortByClosest");
		var list = [];
		var nextLatitude, nextLongitude, dif;
		for (index = 0; index < locations.length; index++) {
			nextLatitude  = locations[ index ].latitude;
			nextLongitude = locations[ index ].longitude;
			if (nextLatitude != null && nextLatitude != '') {
				dif = getDistanceInKilometers_Haversine(latitude, longitude, parseFloat(nextLatitude), parseFloat(nextLongitude));
			} else {
				dif = INFINITY; // infinity
			}
			locations[index].distance = dif;
			list.push(locations[index]);
		}
		list.sort(function(a, b) {
			if (a.distance > b.distance) {
				return 1;
			}
			if (a.distance < b.distance) {
				return -1;
			}
			// a must be equal to b
			return 0;
		});

		var type = getParameterByName('type');
		if (type) {
			list = list.filter(function(element) {
				return (element.category.toLowerCase().replace(' ', '-') === type);
			});
		}

		addMarkers(list, geolocated, latitude, longitude);
	}

	// KUDOS: http://stackoverflow.com/questions/21279559/geolocation-closest-locationlat-long-from-my-position#answer-21297385
	function getDistanceInKilometers_PythagorasEquirectangular(lat1, lon1, lat2, lon2) {
		lat1 = deg2rad(lat1);
		lat2 = deg2rad(lat2);
		lon1 = deg2rad(lon1);
		lon2 = deg2rad(lon2);
		var R = 6371; // km
		var x = (lon2-lon1) * Math.cos((lat1+lat2)/2);
		var y = (lat2-lat1);
		var d = Math.sqrt(x*x + y*y) * R;
		return d;
	}

	// http://stackoverflow.com/questions/27928/calculate-distance-between-two-latitude-longitude-points-haversine-formula/27943#answer-27943
	function getDistanceInKilometers_Haversine(lat1, lon1, lat2, lon2) {
		var R = 6371; // Radius of the earth in km
		var dLat = deg2rad(lat2-lat1);
		var dLon = deg2rad(lon2-lon1); 
		var a = 
			Math.sin(dLat/2) * Math.sin(dLat/2) +
			Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
			Math.sin(dLon/2) * Math.sin(dLon/2)
			; 
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var d = R * c; // Distance in km
		return d;
	}

	// Convert Degress to Radians
	function deg2rad(deg) {
		return deg * (Math.PI/180)
	}

	// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript#answer-901144
	function getParameterByName(name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}

	findUserLocation();

})();


L.mapbox.accessToken = MAP_ACCESS_TOKEN;
var map = L.mapbox.map('map', 'mapbox.light').setView([locations[0].latitude, locations[0].longitude], 13);

/*
L.marker(MAP_START_POSITION, {
    icon: L.mapbox.marker.icon({
        'marker-size': 'large',
        'marker-symbol': 'bus',
        'marker-color': '#fa0'
    })
}).addTo(map);
*/

// Define the icons
var icons = {
	'Farmers Market': L.divIcon({
		// Specify a class name we can refer to in CSS.
		className: 'farmers-market-marker',
		// Set marker width and height
		iconSize: [43, 56],
		popupAnchor: [0, -28]
	}),
	'Community Garden': L.divIcon({
		// Specify a class name we can refer to in CSS.
		className: 'community-garden-marker',
		// Set marker width and height
		iconSize: [43, 56],
		popupAnchor: [0, -28]
	}),
	'Food Pantry': L.divIcon({
		// Specify a class name we can refer to in CSS.
		className: 'food-pantry-marker',
		// Set marker width and height
		iconSize: [43, 56],
		popupAnchor: [0, -28]
	})
};

/*
function addMarker(position) {
	var template = document.getElementById('marker-template');

	var icon = icons[location.category];
	var coordinates = [
		location.latitude,
		location.longitude
	];
	L.marker(coordinates, { icon: icon })
		.bindPopup(template.innerHTML)
		.addTo(map);

	return new mapboxgl.Marker(marker)
		.setLngLat(position)
		.addTo(map);
}
*/

function addYouAreHere(coordinates) {
	var icon = L.divIcon({
		html: '<div class="you-are-here"><span>You are here</span></div>',
		// Set marker width and height
		iconSize: [0, 0],
		//iconAnchor: [0, 0]
	})

	return L.marker(coordinates, { icon: icon })
		.addTo(map);
}

function addMarkers(locations, geolocated, latitude, longitude) {
	var bounds = [];
	for (var index = 0; index < locations.length && index < 20; index++) {
		(function(location) {
			var icon = icons[location.category];
			var coordinates = [
				location.latitude,
				location.longitude
			];
			var popup = L.popup({ maxWidth: INFINITY })
				.setContent(createPopupElement(location));

			L.marker(coordinates, { icon: icon })
				.bindPopup(popup)
				.addTo(map);
			bounds.push(coordinates);
		})(locations[index]);
	}

	//if (geolocated) {
		addYouAreHere([latitude, longitude]);
	//} else {
		//addMarker([latitude, longitude]);
	//}

	bounds.push([latitude, longitude]);

	map.fitBounds(bounds);
	map.scrollWheelZoom.disable();
}

// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript#answer-901144	
function getParameterByName(name, url) {
	if (!url) url = window.location.href;
	name = name.replace(/[\[\]]/g, "\\$&");
	var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
			results = regex.exec(url);
	if (!results) return null;
	if (!results[2]) return '';
	return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function persistTypeParameter(type) {
	if (!type) type = getParameterByName('type');

	var address = getParameterByName('address');
	var searchLink = document.querySelector('.search a[href]');
	var href = '/list';

	if (type) {
		/*
		var form = document.querySelector('form.find');
		var typeField = form.querySelector('input[name="type"]');
		if (!typeField) {
			typeField = document.createElement('input');
			typeField.type = 'hidden';
			typeField.name = 'type';
			form.appendChild(typeField);
		}
		typeField.value = type;
		*/

		var typeArray = type.split('|');

		// SHIM: Only persist the type if there’s only one, since the list page only supports one type at a time (or all types at once).
		if (typeArray.length === 1) {
			href = '/' + typeArray[0];
		}
	}
	if (address) {
		href += '?address=' + address;

		//var addressField = document.querySelector('input[name="address"]');
		//addressField.value = address;
	}
	searchLink.setAttribute('href', href);
}

persistTypeParameter();
//addFilterButtons();

</script>

<!--
<script>
	//var topOfScripts = document.getElementsByTagName("script")[0];
	//var map_script = document.createElement("script")

	if (!mapboxgl.supported()) {
	    document.getElementById("map-not-supported-message").style.display = "block"
	    // map_script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBP5KxqO9v1sLhXlkrG3vDiDdOJvYLJ0H4"
	} else { //map_script.src = "/assets/js/map.js"
	}

	//topOfScripts.appendChild(map_script);
</script>
-->
